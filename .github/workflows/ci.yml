name: CI

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: memory_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        extensions: pdo, pdo_mysql, mysqli

    - name: Install Composer dependencies
      run: composer install --no-progress --prefer-dist --optimize-autoloader

    - name: Wait for MySQL to be ready
      run: |
        for i in {1..30}; do
          if mysql -h 127.0.0.1 -u root -proot -e "SELECT 1" memory_test > /dev/null 2>&1; then
            break
          fi
          echo "Waiting for MySQL to be ready..."
          sleep 2
        done

    - name: Create test database schema
      run: |
        mysql -h 127.0.0.1 -u root -proot memory_test < SQL/tables.sql
        mysql -h 127.0.0.1 -u root -proot memory_test < SQL/functions.sql
        mysql -h 127.0.0.1 -u root -proot memory_test < SQL/views.sql
        mysql -h 127.0.0.1 -u root -proot memory_test < SQL/utility-views.sql
        mysql -h 127.0.0.1 -u root -proot memory_test < SQL/triggers.sql
        mysql -h 127.0.0.1 -u root -proot memory_test < SQL/insert.sql

    - name: Create .env file for testing
      run: |
        cat > .env << EOF
        DB_HOST=127.0.0.1
        DB_USERNAME=root
        DB_PASSWORD=root
        DB_DATABASE=memory_test
        JWT_SECRET_KEY=test_jwt_secret_key_that_is_at_least_256_bits_long_for_testing_purposes_only_and_should_be_long_enough
        JWT_ALGORITHM=HS256
        JWT_EXPIRATION_TIME=3600
        JWT_ISSUER=memory-api-test
        JWT_AUDIENCE=memory-api-test-users
        EOF

    - name: Run PHPUnit tests
      run: ./vendor/bin/phpunit